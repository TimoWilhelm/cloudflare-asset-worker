<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Router Admin</title>
		<link rel="icon" href="data:;base64,iVBORw0KGgo=" />
		<style>
			:root {
				--bg-page: #f9fafb;
				--bg-card: #ffffff;
				--border-color: #eaecf0;
				--text-primary: #101828;
				--text-secondary: #475467;
				--text-tertiary: #667085;
				--primary-color: #0070f3;
				--danger-color: #d92d20;
				--danger-bg: #fef3f2;
			}

			body {
				font-family:
					-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji',
					'Segoe UI Symbol';
				background-color: var(--bg-page);
				color: var(--text-primary);
				margin: 0;
				padding: 2rem;
				line-height: 1.5;
			}

			.container {
				max-width: 1200px;
				margin: 0 auto;
			}

			header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 2rem;
			}

			h1 {
				font-size: 1.5rem;
				font-weight: 600;
				color: var(--text-primary);
				margin: 0;
			}

			.btn {
				display: inline-flex;
				align-items: center;
				justify-content: center;
				padding: 0.5rem 1rem;
				font-size: 0.875rem;
				font-weight: 500;
				border-radius: 6px;
				cursor: pointer;
				transition: all 0.2s ease;
				text-decoration: none;
				gap: 0.5rem;
				border: 1px solid transparent;
			}

			.btn-outline {
				background: white;
				border-color: var(--border-color);
				color: var(--text-secondary);
			}
			.btn-outline:hover {
				background: #f9fafb;
				border-color: #d0d5dd;
				color: var(--text-primary);
			}

			.btn-danger-ghost {
				background: transparent;
				color: var(--text-tertiary);
				padding: 0.4rem;
			}
			.btn-danger-ghost:hover {
				background: var(--danger-bg);
				color: var(--danger-color);
			}

			.card {
				background: var(--bg-card);
				border: 1px solid var(--border-color);
				border-radius: 12px;
				box-shadow: 0 1px 2px rgba(16, 24, 40, 0.05);
				overflow: hidden;
			}

			table {
				width: 100%;
				border-collapse: collapse;
				text-align: left;
			}

			th {
				background-color: #fcfcfd;
				color: var(--text-secondary);
				font-size: 0.75rem;
				font-weight: 600;
				text-transform: uppercase;
				letter-spacing: 0.025em;
				padding: 0.75rem 1.5rem;
				border-bottom: 1px solid var(--border-color);
			}

			td {
				padding: 1rem 1.5rem;
				border-bottom: 1px solid var(--border-color);
				vertical-align: top;
			}

			tr:last-child td {
				border-bottom: none;
			}

			tr:hover td {
				background-color: #fcfcfd;
			}

			/* Column Widths */
			.col-project {
				width: 35%;
			}
			.col-config {
				width: 35%;
			}
			.col-links {
				width: 20%;
			}
			.col-actions {
				width: 10%;
				text-align: right;
			}

			/* Project Column Styling */
			.project-cell {
				display: flex;
				flex-direction: column;
			}
			.project-name {
				font-size: 0.95rem;
				font-weight: 600;
				color: var(--text-primary);
				margin-bottom: 0.15rem;
			}
			.project-meta {
				font-size: 0.8125rem;
				color: var(--text-tertiary);
				display: flex;
				align-items: center;
				gap: 0.5rem;
			}
			.meta-separator {
				color: #d0d5dd;
			}

			/* Badge Styling */
			.badge {
				display: inline-flex;
				align-items: center;
				padding: 0.125rem 0.5rem;
				border-radius: 9999px;
				font-size: 0.75rem;
				font-weight: 500;
				line-height: 1.25;
				white-space: nowrap;
				border: 1px solid transparent;
			}

			/* Config/Deployment Column */
			.deployment-cell {
				display: flex;
				flex-direction: column;
				gap: 0.5rem;
			}
			.status-row {
				display: flex;
				flex-wrap: wrap;
				gap: 0.5rem;
				align-items: center;
			}
			.routes-row {
				display: flex;
				flex-wrap: wrap;
				gap: 0.25rem;
			}
			.route-pill {
				font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
				font-size: 0.75rem;
				color: var(--text-secondary);
				background: #f2f4f7;
				padding: 0.1rem 0.4rem;
				border-radius: 4px;
				border: 1px solid #e4e7ec;
			}

			/* Specific Badges */
			.badge-ssr {
				background: #ecfdf3;
				color: #027a48;
				border-color: #abefc6;
			}
			.badge-static {
				background: #eff8ff;
				color: #175cd3;
				border-color: #b2ddff;
			}
			.badge-worker {
				background: #fdf2fa;
				color: #c11574;
				border-color: #fcceee;
			}
			.badge-assets {
				background: #f9f5ff;
				color: #6941c6;
				border-color: #e9d7fe;
			}

			/* Links Column */
			.links-cell {
				display: flex;
				flex-wrap: wrap;
				gap: 0.5rem;
			}
			.link-btn {
				display: inline-flex;
				align-items: center;
				gap: 0.35rem;
				padding: 0.25rem 0.5rem;
				border-radius: 6px;
				font-size: 0.8125rem;
				color: var(--text-secondary);
				background: white;
				border: 1px solid var(--border-color);
				text-decoration: none;
				transition: all 0.15s;
			}
			.link-btn:hover {
				border-color: #d0d5dd;
				color: var(--text-primary);
				background: #f9fafb;
			}
			.link-btn svg {
				width: 14px;
				height: 14px;
				color: var(--text-tertiary);
			}

			dialog {
				background: white;
				border-radius: 12px;
				width: 90%;
				max-width: 600px;
				max-height: 85vh;
				padding: 0;
				border: none;
				box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
				flex-direction: column;
			}
			dialog[open] {
				display: flex;
			}
			dialog::backdrop {
				background: rgba(0, 0, 0, 0.5);
			}
			.modal-header {
				padding: 1rem 1.5rem;
				border-bottom: 1px solid var(--border-color);
				display: flex;
				justify-content: space-between;
				align-items: center;
			}
			.modal-header h3 {
				margin: 0;
				font-size: 1.1rem;
				font-weight: 600;
			}
			.modal-close {
				background: transparent;
				border: none;
				font-size: 1.5rem;
				line-height: 1;
				cursor: pointer;
				color: var(--text-tertiary);
				padding: 0;
			}
			.modal-close:hover {
				color: var(--text-primary);
			}
			.modal-body {
				padding: 0;
				overflow-y: auto;
				flex: 1;
				background: #f8fafc;
			}
			.json-view {
				margin: 0;
				padding: 1.5rem;
				font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
				font-size: 0.85rem;
				line-height: 1.5;
				color: #334155;
				white-space: pre-wrap;
			}
			.json-key {
				color: #0f172a;
			}
			.json-key.is-override {
				font-weight: 700;
				color: var(--primary-color);
			}
			.json-val.is-override {
				font-weight: 700;
				color: var(--primary-color);
			}
			.json-string {
				color: #059669;
			}
			.json-number {
				color: #d97706;
			}
			.json-boolean {
				color: #7c3aed;
			}
			.json-null {
				color: #94a3b8;
			}
			.empty-state {
				padding: 4rem 2rem;
				text-align: center;
				color: var(--text-tertiary);
				font-size: 0.95rem;
			}

			@media (max-width: 768px) {
				body {
					padding: 0.5rem;
				}

				.container {
					padding: 0;
				}

				thead {
					display: none;
				}

				tr {
					display: flex;
					flex-wrap: wrap;
					gap: 0.5rem;
					padding: 0.75rem;
					border-bottom: 1px solid var(--border-color);
				}

				td {
					padding: 0;
					border: none;
					width: auto;
				}

				.col-project {
					width: 100%;
					order: 1;
				}

				.col-config {
					order: 2;
					flex: 1;
					min-width: 0;
				}

				.col-links {
					flex: 1;
					order: 3;
				}

				.col-actions {
					flex: 1;
					order: 4;
				}

				.project-name {
					word-break: break-all;
					margin-bottom: 0.25rem;
				}

				.project-meta {
					margin-bottom: 0.25rem;
				}

				.deployment-cell {
					flex-direction: row;
					flex-wrap: wrap;
					align-items: center;
				}

				.links-cell {
					justify-content: flex-end;
				}
			}
		</style>
	</head>
	<body>
		<div class="container">
			<header>
				<h1>Router Admin</h1>
				<button class="btn btn-outline" onclick="logout()">Logout</button>
			</header>

			<div class="card">
				<main id="app">
					<div style="padding: 2rem; text-align: center; color: var(--text-tertiary)">Loading projects...</div>
				</main>
			</div>
		</div>

		<dialog id="configModal">
			<div class="modal-header">
				<h3 id="modalTitle">Project Config</h3>
				<form method="dialog">
					<button class="modal-close">&times;</button>
				</form>
			</div>
			<div class="modal-body" id="modalBody">
				<!-- Config content will be injected here -->
			</div>
		</dialog>

		<script>
			let projectData = {};

			const DEFAULT_CONFIG = {
				run_worker_first: false,
				html_handling: 'auto-trailing-slash',
				not_found_handling: 'none',
				has_static_routing: false,
				debug: false,
			};

			function formatJSON(obj, userKeys, indent = 0) {
				const padding = ' '.repeat(indent + 2);

				if (Array.isArray(obj)) {
					if (obj.length === 0) return '[]';
					let html = '[\n';
					obj.forEach((value, index) => {
						html += padding;
						if (typeof value === 'object' && value !== null) {
							html += formatJSON(value, new Set(), indent + 2);
						} else {
							let valClass = '';
							if (typeof value === 'string') valClass = 'json-string';
							else if (typeof value === 'number') valClass = 'json-number';
							else if (typeof value === 'boolean') valClass = 'json-boolean';
							else if (value === null) valClass = 'json-null';

							const displayVal = typeof value === 'string' ? `"${value}"` : String(value);
							html += `<span class="${valClass}">${displayVal}</span>`;
						}

						if (index < obj.length - 1) html += ',';
						html += '\n';
					});
					html += ' '.repeat(indent) + ']';
					return html;
				}

				const keys = Object.keys(obj);
				if (keys.length === 0) return '{}';

				let html = '{\n';
				keys.forEach((key, index) => {
					const value = obj[key];
					const isUserSet = userKeys.has(key);
					const overrideClass = isUserSet ? ' is-override' : '';

					html += `${padding}<span class="json-key${overrideClass}">"${key}"</span>: `;

					if (typeof value === 'object' && value !== null) {
						// Recursive properly for objects
						// For nested objects, we pass down the userKeys check if strictly needed,
						// but here we only track top-level overrides as per request context roughly.
						// To keep it simple and effective: exact keys from user config are what matters.
						// Recurse:
						html += formatJSON(value, new Set(), indent + 2);
					} else {
						let valClass = '';
						if (typeof value === 'string') valClass = 'json-string';
						else if (typeof value === 'number') valClass = 'json-number';
						else if (typeof value === 'boolean') valClass = 'json-boolean';
						else if (value === null) valClass = 'json-null';

						const displayVal = typeof value === 'string' ? `"${value}"` : String(value);
						html += `<span class="${valClass}${overrideClass}">${displayVal}</span>`;
					}

					if (index < keys.length - 1) html += ',';
					html += '\n';
				});
				html += ' '.repeat(indent) + '}';
				return html;
			}

			function openConfig(projectId) {
				const project = projectData[projectId];
				if (!project) return;

				document.getElementById('modalTitle').textContent = `Config: ${projectId}`;

				// Determine user-set keys (top-level only for now for bolding)
				const userConfig = project.config || {};
				const userKeys = new Set(Object.keys(userConfig));
				// Special handling for legacy/top-level run_worker_first
				if (project.hasOwnProperty('run_worker_first')) userKeys.add('run_worker_first');

				// Merge to get effective config
				const fullConfig = {
					...DEFAULT_CONFIG,
					...userConfig,
					run_worker_first: project.config?.run_worker_first ?? project.run_worker_first ?? DEFAULT_CONFIG.run_worker_first,
				};

				const html = `<pre class="json-view">${formatJSON(fullConfig, userKeys)}</pre>`;

				document.getElementById('modalBody').innerHTML = html;
				document.getElementById('configModal').showModal();
			}

			// Close on click outside
			document.getElementById('configModal').addEventListener('click', (e) => {
				const rect = e.target.getBoundingClientRect();
				const clickedInDialog =
					rect.top <= e.clientY && e.clientY <= rect.top + rect.height && rect.left <= e.clientX && e.clientX <= rect.left + rect.width;

				if (!clickedInDialog) {
					e.target.close();
				}
			});

			const token = localStorage.getItem('admin_token');
			if (!token) {
				window.location.href = '/login.html';
			}

			function logout() {
				localStorage.removeItem('admin_token');
				document.cookie = 'admin_token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT';
				window.location.href = '/login.html';
			}

			async function fetchProjects() {
				try {
					const res = await fetch('/__api/projects?limit=100', {
						headers: { Authorization: token },
					});
					if (res.status === 401) return logout();
					const data = await res.json();
					if (!data.success) throw new Error(data.error);
					renderProjects(data.projects);
				} catch (err) {
					document.getElementById('app').innerHTML =
						`<div style="padding: 2rem; color: #d92d20; text-align: center;">Error: ${err.message}</div>`;
				}
			}

			async function deleteProject(id) {
				if (!confirm(`Are you sure you want to delete project "${id}"?`)) return;
				try {
					const res = await fetch(`/__api/projects/${id}`, {
						method: 'DELETE',
						headers: { Authorization: token },
					});
					if (res.ok) {
						fetchProjects();
					} else {
						const data = await res.json();
						alert(data.error || 'Unknown error');
					}
				} catch (err) {
					alert('Failed to delete project');
				}
			}

			function formatDate(isoString) {
				if (!isoString) return 'N/A';
				const date = new Date(isoString);
				return date.toLocaleString(undefined, {
					month: 'short',
					day: 'numeric',
					year: 'numeric',
					hour: 'numeric',
					minute: 'numeric',
				});
			}

			function renderProjects(projectsData) {
				const app = document.getElementById('app');
				if (!projectsData || projectsData.length === 0) {
					app.innerHTML = '<div class="empty-state">No projects found. Deploy some!</div>';
					return;
				}

				// Sort projects by updatedAt (deploy time) descending
				const projects = [...projectsData].sort((a, b) => {
					const dateA = new Date(a.updatedAt || a.createdAt).getTime();
					const dateB = new Date(b.updatedAt || b.createdAt).getTime();
					return dateB - dateA;
				});

				const hostname = window.location.hostname;
				const isLocalhost = hostname === 'localhost' || hostname === '127.0.0.1' || hostname.startsWith('192.168.');
				const hostParts = hostname.split('.');
				const baseDomain = hostParts.length > 2 ? hostParts.slice(-2).join('.') : hostname;
				projects.forEach((p) => (projectData[p.id] = p));
				const port = window.location.port ? ':' + window.location.port : '';

				const rows = projects
					.map((p) => {
						const config = p.config || {};
						const routes = (config.routes || []).map((r) => r.path || r);

						const pathUrl = `/__project/${p.id}/`;
						const subdomainHost = `${p.id}.${baseDomain}${port}`;
						const subdomainUrl = `${window.location.protocol}//${subdomainHost}/`;
						const assetsCount = p.assetsCount || 0;
						const deployTime = p.updatedAt || p.createdAt;

						// Deployment Status Logic
						const isSSR = p.hasServerCode;
						const isWorkerFirst = p.run_worker_first === true || (Array.isArray(p.run_worker_first) && p.run_worker_first.length > 0);

						// Render Links
						let linksHtml = `
						<a href="${pathUrl}" target="_blank" class="link-btn" title="Path Routing">
							<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244" /></svg>
							Path
						</a>
					`;
						if (!isLocalhost) {
							linksHtml =
								`
							<a href="${subdomainUrl}" target="_blank" class="link-btn" title="Subdomain Routing">
								<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9.004 9.004 0 008.716-6.747M12 21a9.004 9.004 0 01-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a8.997 8.997 0 017.843 4.582M12 3a8.997 8.997 0 00-7.843 4.582m15.686 0A11.953 11.953 0 0112 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0121 12c0 .778-.099 1.533-.284 2.253m0 0A17.919 17.919 0 0112 16.5c-3.162 0-6.133-.815-8.716-2.247m0 0A9.015 9.015 0 013 12c0-1.605.42-3.113 1.157-4.418" /></svg>
								Subdomain
							</a>
						` + linksHtml;
						}

						return `
						<tr>
							<td class="col-project">
								<div class="project-cell">
									<div class="project-name">${p.id}</div>
									<div class="project-meta">
										<span>${formatDate(deployTime)}</span>
										<span class="meta-separator">&bull;</span>
										<span>${assetsCount} asset${assetsCount !== 1 ? 's' : ''}</span>
									</div>
								</div>
							</td>
							<td class="col-config">
								<div class="deployment-cell">
									<div class="status-row">
										${isSSR ? `<span class="badge badge-ssr">SSR</span>` : `<span class="badge badge-static">Static</span>`}
									</div>
									<div class="routes-row">
										${routes
											.slice(0, 3)
											.map((r) => `<span class="route-pill">${r}</span>`)
											.join('')}
										${routes.length > 3 ? `<span class="route-pill">+${routes.length - 3}</span>` : ''}
									</div>
								</div>
							</td>
							<td class="col-links">
								<div class="links-cell">
									${linksHtml}
								</div>
							</td>
							<td class="col-actions">
								<div style="display: flex; justify-content: flex-end; gap: 0.5rem;">
									<button class="btn btn-outline" onclick="openConfig('${p.id}')" title="View Config" style="padding: 0.4rem;">
										<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
											<path d="M12 20a8 8 0 1 0 0-16 8 8 0 0 0 0 16Z"/>
											<path d="M12 14a2 2 0 1 0 0-4 2 2 0 0 0 0 4Z"/>
											<line x1="12" y1="2" x2="12" y2="4"/>
											<line x1="12" y1="20" x2="12" y2="22"/>
											<line x1="4.93" y1="4.93" x2="6.34" y2="6.34"/>
											<line x1="17.66" y1="17.66" x2="19.07" y2="19.07"/>
											<line x1="2" y1="12" x2="4" y2="12"/>
											<line x1="20" y1="12" x2="22" y2="12"/>
											<line x1="6.34" y1="17.66" x2="4.93" y2="19.07"/>
											<line x1="19.07" y1="4.93" x2="17.66" y2="6.34"/>
										</svg>
									</button>
									<button class="btn btn-danger-ghost" onclick="deleteProject('${p.id}')" title="Delete Project">
										<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
											<polyline points="3 6 5 6 21 6"></polyline>
											<path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
											<line x1="10" y1="11" x2="10" y2="17"></line>
											<line x1="14" y1="11" x2="14" y2="17"></line>
										</svg>
									</button>
								</div>
							</td>
						</tr>
					`;
					})
					.join('');

				app.innerHTML = `
					<table>
						<thead>
							<tr>
								<th>Project</th>
								<th>Deployment</th>
								<th>Access</th>
								<th style="text-align: right">Actions</th>
							</tr>
						</thead>
						<tbody>
							${rows}
						</tbody>
					</table>
				`;
			}

			if (token) fetchProjects();
		</script>
	</body>
</html>
